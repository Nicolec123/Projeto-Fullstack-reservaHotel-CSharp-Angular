<div class="simular-page">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando...</p>
    </div>
  } @else {
    @if (room(); as r) {
      <div class="simular-container">
        <a [routerLink]="['/quartos', r.id]" class="back-link">‚Üê Voltar ao quarto</a>

        <div class="simulacao-header">
          <h1>Simula√ß√£o: Quarto + Spa</h1>
          <p class="subtitle">Escolha o quarto e, se quiser, adicione um servi√ßo de spa. Depois voc√™ pode seguir para a reserva e pagamento.</p>
        </div>

        <div class="simulacao-card room-summary">
          <h2>Seu quarto</h2>
          <div class="room-row">
            @if (getRoomImageUrl(r.numero); as img) {
              <img [src]="img" [alt]="'Quarto ' + r.numero" class="room-thumb" />
            }
            <div class="room-details">
              <strong>Quarto {{ r.numero }}</strong> ‚Äî {{ r.tipo }}
              <p class="preco-noite">R$ {{ r.precoDiaria | number:'1.2-2' }} / noite</p>
            </div>
          </div>
        </div>

        <div class="simulacao-card spa-choice">
          <h2>Deseja adicionar Spa?</h2>
          <p class="spa-desc">Escolha um servi√ßo individual ou um pacote completo. O valor do spa √© √∫nico (uma vez por reserva).</p>
          
          <div class="spa-tabs">
            <button type="button" class="spa-tab" [class.active]="selectedSpa() !== null || selectedPackage() === null" (click)="selectSpa(null); selectPackage(null)">
              Servi√ßos Individuais
            </button>
            <button type="button" class="spa-tab" [class.active]="selectedPackage() !== null">
              Pacotes Completos
            </button>
          </div>

          <!-- Servi√ßos Individuais -->
          @if (selectedPackage() === null) {
          <div class="spa-options">
            <label class="spa-option" [class.selected]="selectedSpa() === null">
              <input type="radio" name="spa" [checked]="selectedSpa() === null" (change)="selectSpa(null)" />
              <span class="option-label">Sem spa ‚Äî s√≥ hospedagem</span>
            </label>
            @for (spa of spaOptions; track spa.id) {
              <label class="spa-option" [class.selected]="selectedSpa()?.id === spa.id">
                <input type="radio" name="spa" [value]="spa.id" [checked]="selectedSpa()?.id === spa.id" (change)="selectSpa(spa)" />
                <div class="option-content">
                  <span class="option-name">{{ spa.nome }} ¬∑ {{ spa.duracao }}</span>
                  <span class="option-desc">{{ spa.descricao }}</span>
                  <span class="option-price">R$ {{ spa.preco | number:'1.2-2' }}</span>
                </div>
              </label>
            }
          </div>
          }

          <!-- Pacotes Completos -->
          @if (selectedSpa() === null) {
          <div class="spa-packages-section">
            <label class="spa-option" [class.selected]="selectedPackage() === null">
              <input type="radio" name="spaPackage" [checked]="selectedPackage() === null" (change)="selectPackage(null)" />
              <span class="option-label">Sem pacote ‚Äî s√≥ hospedagem</span>
            </label>
            @for (pkg of spaPackages; track pkg.id) {
              <label class="spa-package-option" [class.selected]="selectedPackage()?.id === pkg.id" [class.popular]="pkg.popular">
                <input type="radio" name="spaPackage" [checked]="selectedPackage()?.id === pkg.id" (change)="selectPackage(pkg)" />
                <div class="package-option-content">
                  <div class="package-header">
                    @if (pkg.popular) {
                      <span class="package-badge">Mais Popular</span>
                    }
                    <span class="package-name">{{ pkg.nome }}</span>
                    <span class="package-price">{{ formatarPreco(pkg.precoBase) }}</span>
                  </div>
                  <p class="package-desc">{{ pkg.descricao }}</p>
                  <div class="package-details">
                    <span>‚è±Ô∏è {{ pkg.duracao }}</span>
                    <span>üë• {{ pkg.pessoasIncluidas }} pessoa{{ pkg.pessoasIncluidas > 1 ? 's' : '' }}</span>
                  </div>
                  @if (selectedPackage()?.id === pkg.id && pkg.tipo === 'familia') {
                    <div class="package-pessoas-selector">
                      <label>
                        <span>N√∫mero de pessoas:</span>
                        <input 
                          type="number" 
                          [value]="packageNumPessoas()" 
                          [min]="pkg.pessoasIncluidas"
                          [max]="pkg.pessoasMaximas"
                          (input)="updatePackagePessoas(+$any($event.target).value)"
                        />
                        @if (packageNumPessoas() > pkg.pessoasIncluidas) {
                          <span class="extra-price">+ {{ formatarPreco((packageNumPessoas() - pkg.pessoasIncluidas) * (pkg.precoPorPessoaExtra || 0)) }} por pessoa extra</span>
                        }
                      </label>
                    </div>
                  }
                  <div class="package-final-price">
                    Total: {{ formatarPreco(calculateSpaPackagePrice(pkg.id, selectedPackage()?.id === pkg.id ? packageNumPessoas() : pkg.pessoasIncluidas)) }}
                  </div>
                </div>
              </label>
            }
          </div>
          }
        </div>

        <div class="simulacao-total">
          <h3>Total da simula√ß√£o (1 noite)</h3>
          <div class="total-line">
            <span>Quarto {{ r.numero }}</span>
            <span>R$ {{ r.precoDiaria | number:'1.2-2' }}</span>
          </div>
          @if (selectedSpa(); as spa) {
            <div class="total-line">
              <span>Spa: {{ spa.nome }} ({{ spa.duracao }})</span>
              <span>R$ {{ spa.preco | number:'1.2-2' }}</span>
            </div>
          }
          @if (selectedPackage(); as pkg) {
            <div class="total-line">
              <span>Pacote Spa: {{ pkg.nome }} ({{ packageNumPessoas() }} pessoa{{ packageNumPessoas() > 1 ? 's' : '' }})</span>
              <span>{{ formatarPreco(calculateSpaPackagePrice(pkg.id, packageNumPessoas())) }}</span>
            </div>
          }
          <div class="total-line total-final">
            <span>Total estimado</span>
            <span>R$ {{ totalSimulacao() | number:'1.2-2' }}</span>
          </div>
          <p class="aviso">Valores reais ser√£o calculados conforme as datas e noites escolhidas na reserva. O valor do spa √© fixo por reserva.</p>
        </div>

        <div class="simulacao-actions">
          <button type="button" class="btn-secondary" (click)="apenasQuarto()">
            Reservar s√≥ o quarto
          </button>
          <button type="button" class="btn-primary" (click)="irParaReserva()">
            Quero este pacote ‚Äî ir para reserva e pagamento
          </button>
        </div>
      </div>
    }
  }
</div>
