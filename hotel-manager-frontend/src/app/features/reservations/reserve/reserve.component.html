<div class="reserve-page">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando...</p>
    </div>
  } @else {
    @if (room(); as r) {
      <div class="reserve-container">
        <a routerLink="/quartos" class="back-link">‚Üê Voltar aos quartos</a>

        <div class="steps-indicator">
          <div class="step-item" [class.active]="step() >= 1" [class.done]="step() > 1">
            <span class="step-num">1</span>
            <span class="step-label">Datas</span>
          </div>
          <div class="step-line" [class.done]="step() > 1"></div>
          <div class="step-item" [class.active]="step() >= 2" [class.done]="step() > 2">
            <span class="step-num">2</span>
            <span class="step-label">H√≥spede</span>
          </div>
          <div class="step-line" [class.done]="step() > 2"></div>
          <div class="step-item" [class.active]="step() >= 3" [class.done]="step() >= 4">
            <span class="step-num">3</span>
            <span class="step-label">Pagamento</span>
          </div>
        </div>

        @if (step() === 1) {
          <section class="step-content">
            <div class="room-preview">
              @if (getRoomImageUrl(r.numero); as img) {
                <img [src]="img" [alt]="'Quarto ' + r.numero" class="room-img" />
              }
              <div class="room-info">
                <h1>Quarto {{ r.numero }}</h1>
                <p class="tipo">{{ r.tipo }}</p>
                <p class="preco">R$ {{ r.precoDiaria | number:'1.2-2' }} / noite</p>
                @if (spaAddOn(); as spa) {
                  <p class="spa-badge">+ Spa: {{ spa.nome }} ({{ spa.duracao }}) ‚Äî R$ {{ spa.preco | number:'1.2-2' }}</p>
                }
              </div>
            </div>

            <div class="form-card">
              <h2>Passo 1 ‚Äî Escolha as datas</h2>
              <p class="subtitle">Selecione check-in e check-out para a sua estadia</p>
              @if (error()) {
                <div class="error">{{ error() }}</div>
              }
              <form [formGroup]="form" (ngSubmit)="avancarParaHospede()">
                  <div class="form-row">
                  <label>
                    <span>Check-in</span>
                    <input type="date" formControlName="dataInicio" />
                    <select formControlName="periodoCheckIn" class="periodo-select">
                      <option value="Manh√£">Manh√£</option>
                      <option value="Tarde">Tarde</option>
                      <option value="Noite">Noite</option>
                    </select>
                  </label>
                  <label>
                    <span>Check-out</span>
                    <input type="date" formControlName="dataFim" />
                    <select formControlName="periodoCheckOut" class="periodo-select">
                      <option value="Manh√£">Manh√£</option>
                      <option value="Tarde">Tarde</option>
                      <option value="Noite">Noite</option>
                    </select>
                  </label>
                </div>
                @if (noites > 0) {
                  <p class="preview-price">{{ noites }} {{ noites === 1 ? 'noite' : 'noites' }}{{ spaAddOn() ? ' + Spa' : '' }} ¬∑ Total estimado: R$ {{ precoTotal | number:'1.2-2' }}</p>
                }
                <button type="submit" class="btn-primary" [disabled]="form.invalid">Continuar ‚Üí</button>
              </form>
            </div>
          </section>
        }

        @if (step() === 2) {
          <section class="step-content">
            <div class="form-card">
              <h2>Passo 2 ‚Äî Dados do h√≥spede e ocupa√ß√£o</h2>
              <p class="subtitle">Confirme seus dados e informe quantas pessoas v√£o se hospedar</p>
              <form [formGroup]="form" (ngSubmit)="avancarParaRevisao()">
                <div class="form-section">
                  <h3>Dados pessoais</h3>
                  <div class="form-row">
                    <label>
                      <span>Nome completo</span>
                      <input type="text" [value]="auth.currentUser()?.nome" readonly />
                    </label>
                    <label>
                      <span>E-mail</span>
                      <input type="email" [value]="auth.currentUser()?.email" readonly />
                    </label>
                    <label>
                      <span>Telefone (opcional)</span>
                      <input type="tel" formControlName="telefone" placeholder="(11) 99999-9999" />
                    </label>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Ocupa√ß√£o do quarto</h3>
                  <div class="occupancy-grid">
                    <label>
                      <span>üë§ Adultos</span>
                      <input type="number" formControlName="adultos" min="1" max="10" />
                      <small>M√≠nimo 1 adulto</small>
                    </label>
                    <label>
                      <span>üë∂ Crian√ßas</span>
                      <input type="number" formControlName="criancas" min="0" max="10" />
                      <small>Crian√ßas at√© 5 anos: gr√°tis<br>Crian√ßas acima de 5 anos: R$ {{ taxaCriancaPorNoite }}/noite</small>
                    </label>
                    <label>
                      <span>üêæ Pets</span>
                      <input type="number" formControlName="pets" min="0" max="3" />
                      <small>Taxa: R$ {{ taxaPetPorNoite }}/noite por pet<br>M√°ximo 3 pets</small>
                    </label>
                  </div>
                  <div class="occupancy-summary">
                    <strong>Total de h√≥spedes: {{ totalHospedes }} pessoa{{ totalHospedes > 1 ? 's' : '' }}</strong>
                  </div>
                </div>

                <div class="form-section">
                  <h3>H√≥spedes adicionais</h3>
                  <p class="section-description">Cadastre os dados das pessoas que v√£o se hospedar al√©m de voc√™</p>
                  
                  @for (guest of guestsArray().controls; track $index) {
                    <div class="guest-card">
                      <div class="guest-header">
                        <h4>H√≥spede {{ $index + 1 }}</h4>
                        <button type="button" class="btn-remove" (click)="removeGuest($index)">Remover</button>
                      </div>
                      <div class="form-row">
                        <label>
                          <span>Nome completo *</span>
                          <input type="text" [formControl]="$any(guest).get('nome')" placeholder="Nome completo" />
                        </label>
                        <label>
                          <span>CPF</span>
                          <input type="text" [formControl]="$any(guest).get('cpf')" placeholder="000.000.000-00" maxlength="14" />
                        </label>
                      </div>
                      <div class="form-row">
                        <label>
                          <span>Data de nascimento</span>
                          <input type="date" [formControl]="$any(guest).get('dataNascimento')" />
                        </label>
                        <label>
                          <span>Nacionalidade</span>
                          <input type="text" [formControl]="$any(guest).get('nacionalidade')" placeholder="Ex: Brasileira" />
                        </label>
                      </div>
                      <div class="form-row">
                        <label>
                          <span>Telefone</span>
                          <input type="tel" [formControl]="$any(guest).get('telefone')" placeholder="(11) 99999-9999" />
                        </label>
                        <label>
                          <span>Tipo *</span>
                          <select [formControl]="$any(guest).get('tipo')">
                            <option value="Adulto">Adulto</option>
                            <option value="Crian√ßa">Crian√ßa</option>
                          </select>
                        </label>
                      </div>
                      @if ($any(guest).get('tipo')?.value === 'Crian√ßa' && $any(guest).get('dataNascimento')?.value; as dob) {
                        @if (getIdadeFromDataNascimento(dob) !== null) {
                          <div class="idade-calculada">
                            <strong>Idade calculada: {{ getIdadeFromDataNascimento(dob) }} anos</strong> ‚Äî {{ getIdadeFromDataNascimento(dob)! < 5 ? 'at√© 5 anos: sem taxa' : 'acima de 5 anos: R$ ' + taxaCriancaPorNoite + '/noite' }}
                          </div>
                        }
                      }
                    </div>
                  }

                  <button type="button" class="btn-add-guest" (click)="addGuest()">
                    + Adicionar h√≥spede
                  </button>
                </div>

                <label class="observacoes-label">
                  <span>Observa√ß√µes (opcional)</span>
                  <textarea formControlName="observacoes" rows="5" placeholder="Ex: cama extra, hor√°rio de chegada, necessidades especiais, dados do animal de estima√ß√£o..."></textarea>
                </label>
                <div class="actions">
                  <button type="button" class="btn-secondary" (click)="voltarParaDatas()">‚Üê Voltar</button>
                  <button type="submit" class="btn-primary" [disabled]="form.invalid">Continuar ‚Üí</button>
                </div>
              </form>
            </div>
          </section>
        }

        @if (step() === 3) {
          <section class="step-content">
            <div class="review-container" [formGroup]="form">
              <h2>Passo 3 ‚Äî Revisar e pagamento</h2>
              <p class="review-subtitle">Confira todos os dados antes de confirmar sua reserva</p>
              
              @if (error()) {
                <div class="error-large">{{ error() }}</div>
              }

              <div class="review-main-grid">
                <!-- Quarto e Servi√ßos -->
                <div class="review-section">
                  <h3 class="review-section-title">üõèÔ∏è Quarto e Servi√ßos</h3>
                  <div class="review-section-content">
                    <div class="review-item-large">
                      <div class="review-item-header">
                        <strong>Quarto {{ r.numero }}</strong>
                        <span class="badge-type">{{ r.tipo }}</span>
                      </div>
                      <div class="price-breakdown">
                        <div class="price-line">
                          <span>R$ {{ r.precoDiaria | number:'1.2-2' }} / noite</span>
                          <span>√ó {{ noites }} {{ noites === 1 ? 'noite' : 'noites' }}</span>
                          <span class="price-result">R$ {{ noites * r.precoDiaria | number:'1.2-2' }}</span>
                        </div>
                      </div>
                    </div>
                    @if (spaAddOn(); as spa) {
                      <div class="review-item-large spa-item">
                        <div class="review-item-header">
                          <strong>üßò Spa: {{ spa.nome }}</strong>
                          <span class="badge-duration">{{ spa.duracao }}</span>
                        </div>
                        <div class="price-line">
                          <span>Servi√ßo √∫nico</span>
                          <span class="price-result">R$ {{ spa.preco | number:'1.2-2' }}</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>

                <!-- Datas e Estadia -->
                <div class="review-section">
                  <h3 class="review-section-title">üìÖ Datas e Estadia</h3>
                  <div class="review-section-content">
                    <div class="review-item">
                      <span class="review-label">Check-in</span>
                      <span class="review-value">{{ formatarData(form.value.dataInicio!) }} ‚Äî {{ form.value.periodoCheckIn || 'Tarde' }}</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">Check-out</span>
                      <span class="review-value">{{ formatarData(form.value.dataFim!) }} ‚Äî {{ form.value.periodoCheckOut || 'Manh√£' }}</span>
                    </div>
                    <div class="review-item highlight">
                      <span class="review-label">Per√≠odo</span>
                      <span class="review-value">{{ noites }} {{ noites === 1 ? 'noite' : 'noites' }}</span>
                    </div>
                  </div>
                </div>

                <!-- Ocupa√ß√£o -->
                <div class="review-section">
                  <h3 class="review-section-title">üë• Ocupa√ß√£o</h3>
                  <div class="review-section-content">
                    <div class="review-item">
                      <span class="review-label">üë§ Adultos</span>
                      <span class="review-value">{{ form.value.adultos || 1 }}</span>
                    </div>
                    @if ((form.value.criancas || 0) > 0) {
                      <div class="review-item">
                        <span class="review-label">üë∂ Crian√ßas</span>
                        <span class="review-value">{{ form.value.criancas }}</span>
                        @if (form.value.criancas! > 0) {
                          <small class="review-note">Taxa: R$ {{ taxaCriancaPorNoite }}/noite por crian√ßa (acima de 5 anos)</small>
                        }
                      </div>
                    }
                    @if ((form.value.pets || 0) > 0) {
                      <div class="review-item">
                        <span class="review-label">üêæ Pets</span>
                        <span class="review-value">{{ form.value.pets }}</span>
                        <small class="review-note">Taxa: R$ {{ taxaPetPorNoite }}/noite por pet</small>
                      </div>
                    }
                    <div class="review-item highlight">
                      <span class="review-label">Total de h√≥spedes</span>
                      <span class="review-value-large">{{ totalHospedes }} pessoa{{ totalHospedes > 1 ? 's' : '' }}</span>
                    </div>
                  </div>
                </div>

                <!-- H√≥spede principal -->
                <div class="review-section">
                  <h3 class="review-section-title">üë§ Dados do h√≥spede principal</h3>
                  <div class="review-section-content">
                    <div class="review-item">
                      <span class="review-label">Nome</span>
                      <span class="review-value">{{ auth.currentUser()?.nome }}</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">E-mail</span>
                      <span class="review-value">{{ auth.currentUser()?.email }}</span>
                    </div>
                    @if (form.value.telefone) {
                      <div class="review-item">
                        <span class="review-label">Telefone</span>
                        <span class="review-value">{{ form.value.telefone }}</span>
                      </div>
                    }
                  </div>
                </div>

                <!-- H√≥spedes adicionais -->
                @if (guestsArray().controls.length > 0) {
                  <div class="review-section">
                    <h3 class="review-section-title">üë• H√≥spedes adicionais cadastrados</h3>
                    <div class="review-section-content">
                      @for (g of guestsArray().controls; track $index) {
                        <div class="review-item guest-review-item">
                          <span class="review-label">{{ $any(g).get('nome')?.value || 'H√≥spede ' + ($index + 1) }}</span>
                          <span class="review-value">
                            {{ $any(g).get('tipo')?.value }}
                            @if ($any(g).get('tipo')?.value === 'Crian√ßa' && $any(g).get('dataNascimento')?.value; as dob) {
                              @if (getIdadeFromDataNascimento(dob) !== null) {
                                ‚Äî {{ getIdadeFromDataNascimento(dob) }} anos {{ getIdadeFromDataNascimento(dob)! < 5 ? '(sem taxa)' : '(taxa R$ ' + taxaCriancaPorNoite + '/noite)' }}
                              }
                            }
                          </span>
                          @if ($any(g).get('cpf')?.value) {
                            <span class="review-note">CPF: {{ $any(g).get('cpf')?.value }}</span>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (form.value.observacoes) {
                  <div class="review-section">
                    <h3 class="review-section-title">üìù Observa√ß√µes</h3>
                    <div class="review-section-content">
                      <div class="review-item full-width">
                        <span class="review-value">{{ form.value.observacoes }}</span>
                      </div>
                    </div>
                  </div>
                }
              </div>

              <!-- Resumo Financeiro -->
              <div class="financial-summary">
                <h3>üí∞ Resumo Financeiro</h3>
                <div class="financial-breakdown">
                  <div class="financial-line">
                    <span>Hospedagem ({{ noites }} {{ noites === 1 ? 'noite' : 'noites' }})</span>
                    <span>R$ {{ noites * r.precoDiaria | number:'1.2-2' }}</span>
                  </div>
                  @if (spaAddOn(); as spa) {
                    <div class="financial-line">
                      <span>Spa: {{ spa.nome }}</span>
                      <span>R$ {{ spa.preco | number:'1.2-2' }}</span>
                    </div>
                  }
                  @if (criancasComTaxa > 0) {
                    <div class="financial-line">
                      <span>Taxa crian√ßas acima de 5 anos ({{ criancasComTaxa }} √ó {{ noites }} noites)</span>
                      <span>R$ {{ noites * criancasComTaxa * taxaCriancaPorNoite | number:'1.2-2' }}</span>
                    </div>
                  }
                  @if ((form.value.pets || 0) > 0) {
                    <div class="financial-line">
                      <span>Taxa pets ({{ form.value.pets }} √ó {{ noites }} noites)</span>
                      <span>R$ {{ noites * (form.value.pets || 0) * taxaPetPorNoite | number:'1.2-2' }}</span>
                    </div>
                  }
                  <div class="financial-line total-line">
                    <span><strong>Total a pagar</strong></span>
                    <span class="total-amount">R$ {{ precoTotal | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>

              <!-- Pagamento -->
              <div class="payment-section">
                <h3>üí≥ Forma de pagamento</h3>
                <div class="payment-methods">
                  <label class="payment-method">
                    <input type="radio" formControlName="metodoPagamento" value="CartaoCredito" />
                    <div class="payment-card">
                      <span class="payment-icon">üí≥</span>
                      <div>
                        <strong>Cart√£o de cr√©dito</strong>
                        <small>Pagamento imediato</small>
                      </div>
                    </div>
                  </label>
                  <label class="payment-method">
                    <input type="radio" formControlName="metodoPagamento" value="Pix" />
                    <div class="payment-card">
                      <span class="payment-icon">üì±</span>
                      <div>
                        <strong>PIX</strong>
                        <small>Pagamento instant√¢neo</small>
                      </div>
                    </div>
                  </label>
                  <label class="payment-method">
                    <input type="radio" formControlName="metodoPagamento" value="Boleto" />
                    <div class="payment-card">
                      <span class="payment-icon">üßæ</span>
                      <div>
                        <strong>Boleto</strong>
                        <small>Compensa√ß√£o em at√© 3 dias</small>
                      </div>
                    </div>
                  </label>
                </div>

                @if (form.value.metodoPagamento === 'CartaoCredito') {
                  <div class="card-form">
                    <label>
                      <span>N√∫mero do cart√£o</span>
                      <input type="text" formControlName="tokenPagamento" placeholder="0000 0000 0000 0000" maxlength="19" />
                    </label>
                    <div class="form-row">
                      <label>
                        <span>Validade</span>
                        <input type="text" placeholder="MM/AA" maxlength="5" />
                      </label>
                      <label>
                        <span>CVV</span>
                        <input type="text" placeholder="123" maxlength="3" />
                      </label>
                    </div>
                    <label>
                      <span>Nome no cart√£o</span>
                      <input type="text" placeholder="Nome como est√° no cart√£o" />
                    </label>
                    <p class="payment-info">üí° Este √© um ambiente de demonstra√ß√£o. Nenhum dado real ser√° processado.</p>
                  </div>
                }

                @if (form.value.metodoPagamento === 'Pix' || form.value.metodoPagamento === 'Boleto') {
                  <div class="payment-info-box">
                    <p>üìã O c√≥digo de pagamento ser√° gerado ap√≥s a confirma√ß√£o da reserva e enviado por email.</p>
                  </div>
                }
              </div>

              <div class="actions-large">
                <button type="button" class="btn-secondary-large" (click)="voltarParaHospede()">‚Üê Alterar dados</button>
                <button type="button" class="btn-primary-large" (click)="confirmarReserva()" [disabled]="submitting() || !form.value.metodoPagamento">
                  {{ submitting() ? 'Processando...' : '‚úì Confirmar e finalizar reserva' }}
                </button>
              </div>
            </div>
          </section>
        }

        @if (step() === 4) {
          <section class="step-content success-content">
            <div class="success-card">
              <div class="success-icon">‚úì</div>
              <h1>Reserva confirmada!</h1>
              @if (reservationId()) {
                <p class="reserva-num">N¬∫ da reserva: <strong>#{{ reservationId() }}</strong></p>
              }
              <p>Sua reserva do Quarto {{ r.numero }} foi realizada com sucesso.</p>
              <p class="success-detail">{{ formatarData(form.value.dataInicio!) }} ‚Äî {{ formatarData(form.value.dataFim!) }}{{ spaAddOn() ? ' ¬∑ Quarto + Spa' : '' }} ¬∑ Total: R$ {{ precoTotal | number:'1.2-2' }}</p>
              <p class="email-msg">Um e-mail de confirma√ß√£o ser√° enviado em breve.</p>
              <a routerLink="/minhas-reservas" class="btn-primary">Ver minhas reservas</a>
            </div>
          </section>
        }
      </div>
    }
  }
</div>
